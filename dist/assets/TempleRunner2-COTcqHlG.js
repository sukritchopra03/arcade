import{r as H,j as M}from"./index-CRqe24Pj.js";import{Scene as os,Color as ke,Fog as ss,PerspectiveCamera as ns,WebGLRenderer as is,AmbientLight as as,DirectionalLight as rs,MeshStandardMaterial as m,MeshBasicMaterial as D,Group as We,Mesh as c,BoxGeometry as b,SphereGeometry as N,DoubleSide as so,ConeGeometry as De,CylinderGeometry as ae,OctahedronGeometry as pt,RingGeometry as ls,TorusGeometry as no}from"./three.module-Ck8estzQ.js";import{B as cs}from"./BackButton-DJX8SMkP.js";function hs(){const Se=H.useRef(null),[qe,Le]=H.useState("menu"),[Fe,ut]=H.useState(0),[dt,V]=H.useState(0),[io,ao]=H.useState(!1),[ye,ro]=H.useState(()=>+(localStorage.getItem("tr2Best")||0)),[mt,Ze]=H.useState(0),[ft,Ne]=H.useState(1),[Ke,_]=H.useState(null),[lo,Ae]=H.useState(12),[ht,wt]=H.useState(null),[co,Ue]=H.useState(!1),[po,Ye]=H.useState([]),[gt,yt]=H.useState(""),[uo,Te]=H.useState(!1),[bt,vt]=H.useState(""),[mo,Re]=H.useState(!1),[ps,fo]=H.useState("Pistol"),[us,xt]=H.useState(2),me=H.useRef({});return H.useEffect(()=>{let G=!1;const E=Se.current;if(!E)return;const A=new os;A.background=new ke(1710638),A.fog=new ss(1710638,10,90);const Mt=E.clientWidth,kt=E.clientHeight,Z=new ns(70,Mt/kt,.1,200);Z.position.set(0,4.5,8);const re=new is({antialias:!0});re.setSize(Mt,kt),re.setPixelRatio(Math.min(window.devicePixelRatio,2)),re.shadowMap.enabled=!0,E.appendChild(re.domElement),A.add(new as(16777215,.55));const Ve=new rs(16773328,.9);Ve.position.set(5,15,10),Ve.castShadow=!0,A.add(Ve);const Xe=new m({color:7034176,roughness:.9}),Je=new m({color:11575424,roughness:.8}),be=new m({color:3810584,roughness:.9}),$e=new m({color:13382451,roughness:.5}),ho=new m({color:3385924,roughness:.5}),wo=new m({color:3368703,roughness:.4,emissive:2245802,emissiveIntensity:.2}),go=new m({color:16768256,metalness:.8,roughness:.2}),yo=new m({color:16711935,metalness:.9,roughness:.1,emissive:16711935,emissiveIntensity:.3}),bo=new D({color:65535,transparent:!0,opacity:.5}),Dt=new m({color:16724838,metalness:.7,roughness:.3,emissive:16724838,emissiveIntensity:.3}),St=new m({color:3342336,roughness:.7}),vo=new m({color:11176004,roughness:.8}),At=new m({color:2254370,roughness:.9}),xo=new m({color:16737792,metalness:.5,roughness:.6}),Mo=new m({color:9139029,roughness:.85});new D({color:16763972,transparent:!0,opacity:.6}),new D({color:16746564,transparent:!0,opacity:.5});const Pe=new D({color:16776960}),Tt=new m({color:4521796,metalness:.5,roughness:.3,emissive:2271778,emissiveIntensity:.4}),_e=new D({color:13421772}),jt=new m({color:4456448,roughness:.5,emissive:3342336,emissiveIntensity:.3}),ko=new D({color:65535}),zt=new m({color:6750054,roughness:.35,metalness:.35}),Do=["normal","dirt","water","ice","lava","minecart","sky"],Et={normal:"üèõÔ∏è Temple Path",dirt:"üü§ Dirt Trail",water:"üåä Water River",ice:"‚ùÑÔ∏è Ice Path",lava:"üî• Lava Bridge",minecart:"‚õèÔ∏è Mine Shaft",sky:"‚òÅÔ∏è Sky Bridge"},So=new m({color:9136404,roughness:1}),Ao=new m({color:7032594,roughness:1}),To=new m({color:5914122,roughness:.95}),jo=new m({color:2254523,roughness:.2,transparent:!0,opacity:.75}),zo=new m({color:1136042,roughness:.2,transparent:!0,opacity:.75}),Eo=new m({color:9132587,roughness:.8}),Lo=new m({color:11197951,roughness:.05,metalness:.3}),No=new m({color:13430527,roughness:.05,metalness:.3}),Ro=new m({color:8960989,roughness:.1,transparent:!0,opacity:.6}),Po=new m({color:1706506,roughness:.9}),Go=new m({color:2755082,roughness:.9}),Co=new m({color:16729088,emissive:16720384,emissiveIntensity:.8,roughness:.3}),Io=new m({color:3815994,roughness:.95}),Bo=new m({color:4868682,roughness:.95}),Ho=new m({color:2763306,roughness:.9}),Oo=new D({color:8947848}),Wo=new m({color:15658751,roughness:.4,transparent:!0,opacity:.55}),qo=new m({color:14540287,roughness:.4,transparent:!0,opacity:.55}),Fo=new m({color:13421823,roughness:.4,transparent:!0,opacity:.3}),Zo=window.AudioContext||window.webkitAudioContext;let B=null;function Ko(){try{B=new Zo}catch{B=null}}function x(t,s,p,w){if(!(!B||B.state==="suspended"))try{const v=B.createOscillator(),f=B.createGain();v.type=p||"sine",v.frequency.value=t,f.gain.value=w||.1,f.gain.exponentialRampToValueAtTime(.001,B.currentTime+s),v.connect(f),f.connect(B.destination),v.start(),v.stop(B.currentTime+s)}catch{}}function ve(t,s,p,w,v){if(!(!B||B.state==="suspended"))try{const f=B.createOscillator(),i=B.createGain();f.type=w||"sine",f.frequency.value=t,f.frequency.linearRampToValueAtTime(s,B.currentTime+p),i.gain.value=v||.08,i.gain.exponentialRampToValueAtTime(.001,B.currentTime+p),f.connect(i),i.connect(B.destination),f.start(),f.stop(B.currentTime+p)}catch{}}function T(t){if(B)switch(B.state==="suspended"&&B.resume(),t){case"coin":x(1200,.06,"sine",.1),setTimeout(()=>x(1600,.04,"sine",.07),25);break;case"gem":x(800,.15,"sine",.12),setTimeout(()=>{x(1200,.12,"sine",.1),setTimeout(()=>x(1600,.1,"sine",.08),50)},40);break;case"powerup":[600,800,1e3,1200].forEach((s,p)=>setTimeout(()=>x(s,.08,"sine",.09),p*25));break;case"shield":x(400,.2,"sine",.08);break;case"shoot":x(800,.08,"square",.1),setTimeout(()=>x(600,.06,"square",.07),40);break;case"hit":x(200,.12,"sawtooth",.12),setTimeout(()=>x(150,.15,"square",.09),50);break;case"guard":x(120,.35,"sawtooth",.11),setTimeout(()=>x(80,.4,"square",.08),60);break;case"jump":ve(280,680,.12,"sine",.07);break;case"djump":ve(500,1100,.1,"sine",.08),setTimeout(()=>x(1300,.04,"sine",.06),40);break;case"fastfall":ve(600,200,.18,"sawtooth",.09);break;case"slam":x(80,.15,"square",.12),setTimeout(()=>x(60,.2,"sine",.08),30);break;case"slide":x(110,.18,"sawtooth",.04);break;case"land":x(90,.06,"sine",.05);break;case"death":x(180,.45,"sawtooth",.13),setTimeout(()=>x(70,.6,"square",.07),80);break;case"start":[400,600,800].forEach((s,p)=>setTimeout(()=>x(s,.1,"sine",.08),p*35));break;case"ammo":x(500,.08,"sine",.09),setTimeout(()=>x(800,.06,"sine",.07),30);break;case"zip":ve(300,800,.3,"sine",.06);break;case"turn":x(350,.12,"sine",.08),setTimeout(()=>x(500,.08,"sine",.06),40);break;case"boss":x(80,.5,"sawtooth",.15),setTimeout(()=>x(60,.5,"square",.1),100);break;case"resurrect":[500,700,900,1100,1300].forEach((s,p)=>setTimeout(()=>x(s,.1,"sine",.1),p*40));break;case"achieve":[800,1e3,1200,1400].forEach((s,p)=>setTimeout(()=>x(s,.12,"sine",.1),p*50));break;case"crumble":x(60,.3,"square",.08),setTimeout(()=>x(40,.4,"sawtooth",.06),50);break;case"rampage":[400,600,800,1e3,1200,1400].forEach((s,p)=>setTimeout(()=>x(s,.1,"square",.12),p*30));break;case"destroy":x(300,.08,"sawtooth",.06);break;case"splash":ve(400,100,.3,"sine",.1),setTimeout(()=>x(80,.2,"sine",.06),50);break;case"trackchange":[500,700,900,700,500].forEach((s,p)=>setTimeout(()=>x(s,.08,"sine",.08),p*40));break;case"shotgun":[260,220,180].forEach((s,p)=>setTimeout(()=>x(s,.05,"square",.1),p*18));break;case"laser":ve(1400,400,.18,"sine",.09);break;case"grenade":x(140,.1,"square",.1),setTimeout(()=>x(90,.1,"sawtooth",.08),45);break;case"explode":x(120,.22,"sawtooth",.12),setTimeout(()=>x(70,.18,"square",.07),55);break;case"shop":[700,900,1100].forEach((s,p)=>setTimeout(()=>x(s,.08,"sine",.07),p*55));break;case"switch":[500,750].forEach((s,p)=>setTimeout(()=>x(s,.06,"sine",.06),p*40));break}}const r=new We;A.add(r);let X=[],Q=[],j=[],O=[],ee=[],te=[],J=[],Y=[],oe=[],h=[],W=[],Lt=[],fe=[],he=[],we=[],de=[],ge=[];const Uo=new m({color:16729088,metalness:.8,roughness:.2,emissive:16720384,emissiveIntensity:.6});let Qe,le=0,se=0,ce=-30,L=null,R=null;const S=[-2,0,2],q=20,Nt=-.02,je=[{name:"Temple",sky:1710638,fog:1710638,ground:7034176,groundAlt:11575424,wall:3810584,weather:null},{name:"Jungle",sky:1718810,fog:2771498,ground:3824170,groundAlt:5929546,wall:2767386,weather:"leaves"},{name:"Cave",sky:328976,fog:657946,ground:3816010,groundAlt:5921386,wall:1710634,weather:"dust"},{name:"Desert",sky:6969914,fog:5917226,ground:13215870,groundAlt:15321246,wall:9071178,weather:"sand"},{name:"Ice",sky:2771562,fog:3824250,ground:11193582,groundAlt:14544639,wall:6982314,weather:"snow"},{name:"Lava",sky:2755082,fog:3803658,ground:4856346,groundAlt:6957610,wall:1706506,weather:"ember"},{name:"Sky",sky:4881066,fog:5933755,ground:11193565,groundAlt:13430527,wall:9087692,weather:"cloud"},{name:"Night",sky:328981,fog:657962,ground:2763338,groundAlt:4868714,wall:1710634,weather:"star"}];let K=je[0];const Ge={},Yo={dist500:"üèÉ Explorer ‚Äî 500m",dist1000:"üó∫Ô∏è Adventurer ‚Äî 1000m",dist2500:"üèîÔ∏è Trailblazer ‚Äî 2500m",dist5000:"üåç World Runner ‚Äî 5000m",coins50:"ü™ô Coin Collector",coins100:"üí∞ Rich Runner",coins200:"ü§ë Gold Hoarder",killGuard:"‚öîÔ∏è Guardian Slayer",killBoss:"üëπ Boss Killer",combo20:"üî• Combo Master"};let xe=[];function Rt(){const t=30+Math.floor(Math.random()*30),s=500+Math.floor(Math.random()*500);return[{desc:`Collect ${t} coins`,type:"coins",target:t,done:!1},{desc:`Run ${s}m`,type:"dist",target:s,done:!1},{desc:"Kill the Guardian",type:"killGuard",target:1,done:!1}]}function Pt(){return{inMenu:!0,started:!1,over:!1,paused:!1,speed:.22,dist:0,coins:0,gems:0,combo:0,mult:1,lastCoin:0,shield:0,magnet:0,guardDist:-100,guardianHealth:3,ammo:12,resurrected:!1,superMode:!1,weapon:"pistol",grenades:2,bgmT:.12,bgmStep:0,shopMode:0,turnCooldown:0,turnSwoop:0,bossActive:!1,bossHealth:0,deathAnim:0,guardsKilled:0,lastBossDist:0,rampage:0,rampageShotTimer:0,trackType:"normal"}}function Gt(){return{lane:1,y:0,vy:0,jumping:!1,canDbl:!0,ducking:!1,duckT:0,runT:0,fastFall:!1,onZipline:!1,zipT:0,zipDown:!1,zipStartY:0}}let o=Pt(),l=Gt();const u=new We,U=new c(new b(.6,1,.4),new m({color:4491519}));U.position.y=1.2,U.castShadow=!0;const Ce=new c(new N(.25,8,8),new m({color:16764074}));Ce.position.y=2,Ce.castShadow=!0;const Ct=new b(.2,.6,.2),It=new m({color:2245768}),et=new c(Ct,It);et.position.set(-.15,.4,0);const tt=new c(Ct,It);tt.position.set(.15,.4,0);const Bt=new b(.15,.55,.15),Ht=new m({color:4491519}),ot=new c(Bt,Ht);ot.position.set(-.45,1.2,0);const Ie=new c(Bt,Ht);Ie.position.set(.45,1.2,0);const Ot=new c(new b(.1,.1,.4),new m({color:2236962,metalness:.9}));Ot.position.set(0,-.22,-.25),Ie.add(Ot),u.add(U,Ce,et,tt,ot,Ie),u.userData={body:U,head:Ce,lLeg:et,rLeg:tt,lArm:ot,rArm:Ie},u.position.set(0,0,0),A.add(u);const $=new c(new N(1.2,12,12),new D({color:65535,transparent:!0,opacity:.15,side:so}));$.visible=!1,$.position.y=1.2,u.add($),L=new We;const st=new c(new b(1.2,1.4,.8),St);st.position.y=1.5,st.castShadow=!0;const Wt=new c(new N(.4,8,8),St);Wt.position.y=2.6;const nt=new c(new N(.08,6,6),new D({color:16711680}));nt.position.set(-.15,2.7,.35);const qt=nt.clone();qt.position.set(.15,2.7,.35),L.add(st,Wt,nt,qt),L.position.set(0,0,-100),L.visible=!1,A.add(L),R=new We;const it=new c(new b(2,2.2,1.2),jt);it.position.y=2,it.castShadow=!0;const Ft=new c(new N(.6,8,8),jt);Ft.position.y=3.8;const at=new c(new N(.12,6,6),new D({color:16711680}));at.position.set(-.25,3.9,.55);const Zt=at.clone();Zt.position.set(.25,3.9,.55);const Be=new c(new De(.15,.6,6),new m({color:11141120}));Be.position.set(-.3,4.4,0),Be.rotation.z=.3;const rt=Be.clone();rt.position.set(.3,4.4,0),rt.rotation.z=-.3,R.add(it,Ft,at,Zt,Be,rt),R.position.set(0,0,-200),R.visible=!1,A.add(R);for(let t=0;t<30;t++){const s=new c(new b(.02,.02,3+Math.random()*2),new D({color:16777215,transparent:!0,opacity:0}));s.position.set((Math.random()-.5)*14,Math.random()*6,-20-Math.random()*40),A.add(s),Lt.push(s)}function Vo(t){o.weapon=t,fo(t[0].toUpperCase()+t.slice(1)),T("switch"),P("üî´ Weapon: "+(t[0].toUpperCase()+t.slice(1)))}function Xo(t=1){o.shopMode=7,T("shop"),P("üõçÔ∏è Gift Shop Alley Open!");for(let f=0;f<4;f++){const i=-8-f*8,a=new c(new b(7,.4,7),new m({color:4930090,roughness:.9}));a.position.set(0,-.2,i),r.add(a),h.push(a);const d=new c(new b(.6,3.2,7),new m({color:6966579,roughness:.9}));d.position.set(-3.8,1.6,i),r.add(d),h.push(d);const g=d.clone();g.position.x=3.8,r.add(g),h.push(g)}const s=new c(new pt(.35,0),Dt);s.position.set(0,1.2,-12),s.userData={type:"weapon"},r.add(s),J.push(s);const p=new c(new b(.55,.55,.55),zt);p.position.set(-2,.6,-14),p.userData={type:"grenade"},r.add(p),Y.push(p);const w=new c(new b(.55,.55,.55),Tt);w.position.set(2,.6,-16),w.userData={type:"ammo"},r.add(w),Y.push(w);const v=new c(new b(4.5,3.2,2.6),new m({color:8150337,roughness:.85}));v.position.set(t*7.2,1.6,-10),r.add(v),h.push(v)}function Jo(){if(!o.started||o.over||o.paused)return;const t=o.weapon||"pistol";if(t==="pistol"){if(o.ammo<=0)return;o.ammo--,Ae(o.ammo);const s=new c(new N(.15,8,8),Pe);s.position.set(u.position.x,u.position.y+1.2,u.position.z-.5),s.userData={speed:1.2,dmg:1,pierce:0},A.add(s),W.push(s),T("shoot")}else if(t==="shotgun"){if(o.ammo<2)return;o.ammo-=2,Ae(o.ammo);for(let s=-2;s<=2;s++){const p=new c(new N(.12,6,6),Pe);p.position.set(u.position.x,u.position.y+1.2,u.position.z-.5),p.userData={speed:1.15,dmg:1,pierce:0,vx:s*.028},A.add(p),W.push(p)}T("shotgun")}else if(t==="laser"){if(o.ammo<3)return;o.ammo-=3,Ae(o.ammo);const s=new c(new N(.14,8,8),ko);s.position.set(u.position.x,u.position.y+1.2,u.position.z-.5),s.userData={speed:2.2,dmg:2,pierce:3},A.add(s),W.push(s),T("laser")}else if(t==="grenade"){if(o.grenades<=0)return;o.grenades--,xt(o.grenades);const s=new c(new N(.2,8,8),zt);s.position.set(u.position.x,u.position.y+1.1,u.position.z-.5),s.userData={speed:.75,dmg:3,blast:2.5,vy:.05,life:2.4},A.add(s),W.push(s),T("grenade")}for(let s=0;s<3;s++){const p=new c(new N(.12,4,4),new D({color:16755200,transparent:!0}));p.position.set(u.position.x+(Math.random()-.5)*.2,u.position.y+1.2,u.position.z-.5),A.add(p),oe.push({mesh:p,vy:Math.random()*.05,life:.2,maxLife:.2})}}function lt(t){const s=Math.round(Math.abs(t)/q),p=o.trackType;let w,v,f;switch(p){case"dirt":w=So,v=Ao,f=To;break;case"water":w=jo,v=zo,f=be;break;case"ice":w=Lo,v=No,f=Ro;break;case"lava":w=Po,v=Go,f=Co;break;case"minecart":w=Io,v=Bo,f=Ho;break;case"sky":w=Wo,v=qo,f=Fo;break;default:w=Xe,v=Je,f=be;break}const i=new c(new b(7,.5,q),s%2?v:w);i.position.set(0,-.25,t),i.receiveShadow=!0,r.add(i),X.push(i);const a=p==="sky"?1.5:p==="water"?2:3;for(const e of[-3.75,3.75]){const n=new c(new b(.5,a,q),f);n.position.set(e,a/2,t),r.add(n),Q.push(n)}const d=p==="water"?8965375:p==="ice"?11202303:p==="lava"?16737792:p==="minecart"?6710886:p==="sky"?11184895:16763972,g=new D({color:d,transparent:!0,opacity:.6});for(const e of[-1,1]){const n=new c(new b(.08,.04,q),g);n.position.set(e,.02,t),r.add(n),h.push(n)}const k=p==="water"?4491468:p==="lava"?16729088:p==="minecart"?5592405:p==="sky"?8947916:16746564,F=new D({color:k,transparent:!0,opacity:.5});for(let e=0;e<6;e++){const n=new c(new b(7,.04,.15),F);n.position.set(0,.02,t-q/2+e*(q/6)+1.5),r.add(n),h.push(n)}if(p==="water")for(let e=0;e<4;e++){const n=new c(new ls(.3,.5,8),new D({color:8965375,transparent:!0,opacity:.3,side:so}));n.rotation.x=-Math.PI/2,n.position.set((Math.random()-.5)*5,.05,t-Math.random()*q),r.add(n),h.push(n)}else if(p==="ice")for(let e=0;e<3;e++){const n=new c(new De(.2,.8,4),new m({color:11197951,transparent:!0,opacity:.7,metalness:.5}));n.position.set(Math.random()<.5?-3.2:3.2,.5+Math.random()*2,t-Math.random()*q),r.add(n),h.push(n)}else if(p==="lava")for(const e of[-3.2,3.2]){const n=new c(new b(.3,.15,q),new D({color:16729088,transparent:!0,opacity:.6}));n.position.set(e,.08,t),r.add(n),h.push(n)}else if(p==="minecart"){for(const e of S)for(const n of[-.3,.3]){const y=new c(new b(.06,.06,q),Oo);y.position.set(e+n,.05,t),r.add(y),h.push(y)}for(let e=0;e<10;e++){const n=new c(new b(6,.04,.2),new m({color:5914122,roughness:.9}));n.position.set(0,.03,t-q/2+e*(q/10)+1),r.add(n),h.push(n)}}else if(p==="sky")for(let e=0;e<3;e++){const n=new c(new N(1+Math.random(),6,6),new D({color:16777215,transparent:!0,opacity:.25}));n.position.set((Math.random()-.5)*10,-2-Math.random()*3,t-Math.random()*q),r.add(n),h.push(n)}else if(p==="dirt")for(let e=0;e<5;e++)for(const n of[-3.5,3.5]){const y=new c(new b(.15,1.5,.15),new m({color:7032594,roughness:.9}));y.position.set(n,.75,t-e*4),r.add(y),h.push(y)}}function ct(t){const s=Math.random,p=s(),w=o.dist,v=o.trackType;if(s()<.07&&w>80&&o.turnCooldown<=0){o.turnCooldown=18;const i=new c(new b(8,6,1.5),new m({color:8930338,roughness:.8}));i.position.set(0,3,t),i.userData={type:"deadwall",triggered:!1},r.add(i),j.push(i),we.push(i);const a=new c(new b(8.5,.6,2),new m({color:6697745,roughness:.7}));a.position.set(0,6.3,t),r.add(a),h.push(a);for(let e=0;e<3;e++){const n=new c(new b(7.5,.35,.1),new D({color:e%2?16755200:16711680}));n.position.set(0,1.2+e*1.5,t+.8),r.add(n),h.push(n)}const d=new c(new b(16,.5,7),new m({color:5917232,roughness:.9}));d.position.set(-11.5,-.25,t),r.add(d),h.push(d);for(const e of[-3.75,3.75]){const n=new c(new b(16,3,.5),be);n.position.set(-11.5,1.5,t+e),r.add(n),h.push(n)}const g=new c(new b(16,.5,7),new m({color:5917232,roughness:.9}));g.position.set(11.5,-.25,t),r.add(g),h.push(g);for(const e of[-3.75,3.75]){const n=new c(new b(16,3,.5),be);n.position.set(11.5,1.5,t+e),r.add(n),h.push(n)}const k=new c(new De(.8,1.5,4),new D({color:65348}));k.position.set(-2.5,4.5,t+1.5),k.rotation.z=Math.PI/2,r.add(k),h.push(k);const F=new c(new De(.8,1.5,4),new D({color:65348}));F.position.set(2.5,4.5,t+1.5),F.rotation.z=-Math.PI/2,r.add(F),h.push(F);for(const e of[-2,0,2]){const n=new c(new N(.3,8,8),new D({color:16729088}));n.position.set(e,6.8,t),r.add(n),h.push(n)}for(let e=0;e<6;e++){const n=new c(new b(7,.08,.5),new D({color:e%2?16755200:16729088}));n.position.set(0,.06,t+3+e*2.5),r.add(n),h.push(n)}return}if(v==="water"){const i=1+Math.floor(s()*2),a=[];for(let d=0;d<i;d++){let g;do g=Math.floor(s()*3);while(a.includes(g));a.push(g);const k=new c(new b(1.8,.3,14),Eo);k.position.set(S[g],.15,t-7),k.userData={type:"boat",lane:g},r.add(k),ge.push(k);for(const F of[-.85,.85]){const e=new c(new b(.1,.25,14),new m({color:7028768,roughness:.8}));e.position.set(S[g]+F,.32,t-7),r.add(e),h.push(e)}if(s()<.3){const F=new c(new ae(.05,.05,2,6),new m({color:9132587}));F.position.set(S[g],1.2,t-7),r.add(F),h.push(F)}}for(let d=0;d<3;d++)if(!a.includes(d)&&s()<.5){const g=new c(new N(.25,6,6),new D({color:6728447,transparent:!0,opacity:.4}));g.position.set(S[d],.3,t-3-s()*8),r.add(g),h.push(g)}}else if(v==="ice"){if(s()<.35){const i=Math.floor(s()*3),a=new c(new De(.3,1.5,5),new m({color:11197951,transparent:!0,opacity:.8}));a.position.set(S[i],.75,t),a.userData={type:"jump"},r.add(a),j.push(a)}if(s()<.2){const i=new c(new De(.15,1.2,5),new m({color:13430527,transparent:!0,opacity:.7}));i.position.set(S[Math.floor(s()*3)],2.5,t-4),i.rotation.x=Math.PI,i.userData={type:"duck"},r.add(i),j.push(i)}}else if(v==="lava"){if(s()<.3){const i=Math.floor(s()*3),a=new c(new ae(.15,.4,2.5,6),new D({color:16729088,transparent:!0,opacity:.7}));a.position.set(S[i],1.25,t),a.userData={type:"jump"},r.add(a),j.push(a);const d=new c(new ae(.5,.5,.1,8),new D({color:16737792,transparent:!0,opacity:.5}));d.position.set(S[i],.05,t),r.add(d),h.push(d)}if(s()<.2){const i=new c(new N(.35,6,6),new m({color:6689024,emissive:4460800,emissiveIntensity:.5}));i.position.set(S[Math.floor(s()*3)],1,t-8),i.userData={type:"moving",speed:.2+s()*.15},r.add(i),O.push(i)}}else if(v==="dirt"){if(s()<.3){const i=Math.floor(s()*3),a=new c(new N(.5,6,6),new m({color:8943462,roughness:1}));a.position.set(S[i],.5,t),a.userData={type:"jump"},r.add(a),j.push(a)}if(s()<.2){const i=new c(new ae(.7,.7,.06,8),new D({color:4861968,transparent:!0,opacity:.6}));i.position.set(S[Math.floor(s()*3)],.04,t-3),r.add(i),h.push(i)}}else if(v==="minecart"){if(s()<.3){const i=Math.floor(s()*3),a=new c(new b(1.2,.8,1.8),new m({color:6710886,metalness:.7,roughness:.4}));a.position.set(S[i],.4,t-15),a.userData={type:"train",speed:.2+s()*.15},r.add(a),O.push(a)}if(s()<.25){const i=new c(new b(6.5,.4,.5),new m({color:5914122,roughness:.9}));i.position.set(0,1.3,t-5),i.userData={type:"duck"},r.add(i),j.push(i)}}else if(v==="sky"){if(s()<.25){const i=new c(new N(.3,6,6),new D({color:13426175,transparent:!0,opacity:.6}));i.position.set(S[Math.floor(s()*3)],1+s()*.8,t-8),i.userData={type:"moving",speed:.3+s()*.2},r.add(i),O.push(i)}if(s()<.12){const i=new c(new b(7,.1,4),new D({color:0,transparent:!0,opacity:0}));i.position.set(0,-.3,t-2),i.userData={type:"gap"},r.add(i),j.push(i);for(let a=0;a<3;a++){const d=new c(new N(.3,4,4),new D({color:16777215,transparent:!0,opacity:.3}));d.position.set((s()-.5)*6,-.2,t-2+(s()-.5)*3),r.add(d),h.push(d)}return}}if(p<.09&&w>60){const i=new c(new b(7,.2,.25),new D({color:16729156}));i.position.set(0,.08,t+1.8),r.add(i),h.push(i);const a=i.clone();a.position.set(0,.08,t-1.8),r.add(a),h.push(a);for(let g=-2;g<=2;g++){const k=new c(new b(.3,.12,3.6),new D({color:Math.abs(g)%2?16755200:0}));k.position.set(g*1.5,.05,t),r.add(k),h.push(k)}const d=new c(new b(7,.1,3.6),new D({color:0,transparent:!0,opacity:.9}));d.position.set(0,-.3,t),d.userData={type:"gap"},r.add(d),j.push(d);return}if(s()<.09&&w>50){const i=Math.floor(s()*3),a=s()<.4,d=a?22:18,g=new c(new ae(.04,.04,d,6),_e);g.rotation.z=Math.PI/2,g.rotation.x=a?.35:.12;const k=a?4.5:3.5;g.position.set(S[i],k,t-8),g.userData={type:"zipline",lane:i,downward:a},r.add(g),fe.push(g);const F=new c(new ae(.08,.08,a?6:4,6),_e);F.position.set(S[i],a?3:2,t),r.add(F),h.push(F);const e=new c(new ae(.08,.08,a?2.5:4,6),_e);e.position.set(S[i],a?1.25:2,t-16),r.add(e),h.push(e);const n=new c(new b(.4,.25,.2),new m({color:16763904,emissive:16755200,emissiveIntensity:.5}));if(n.position.set(S[i],k-.3,t-1),r.add(n),h.push(n),a){const y=new c(new b(.6,.15,.15),new D({color:16746496}));y.position.set(S[i],k+.3,t-1),r.add(y),h.push(y)}}if(p<.5){const i=Math.floor(s()*3),a=s()<.18&&w>120,d=new c(new b(1.6,a?1.8:1,.5),$e);if(d.position.set(S[i],a?.9:.5,t),d.userData={type:"jump"},r.add(d),j.push(d),s()<.3){const g=(i+1+Math.floor(s()*2))%3,k=new c(new b(1.6,1,.5),$e);k.position.set(S[g],.5,t),k.userData={type:"jump"},r.add(k),j.push(k)}if(s()<.1&&w>200)for(let g=0;g<3;g++){const k=new c(new b(1.4,.6,.4),$e);k.position.set(S[g],.3,t-2),k.userData={type:"jump"},r.add(k),j.push(k)}}else{const i=new c(new b(6,.4,.4),ho);i.position.set(0,1.3,t),i.userData={type:"duck"},r.add(i),j.push(i)}if(s()<.18&&w>40){const i=Math.floor(s()*3),a=new c(new N(.35,8,8),wo);a.position.set(S[i],1+s()*.8,t-10),a.userData={type:"moving",speed:.25+s()*.15},r.add(a),O.push(a)}if(s()<.14&&w>60){const i=Math.floor(s()*3),a=new c(new b(1.8,.3,4),vo);a.position.set(S[i],.15,t-6),a.rotation.x=-.3,r.add(a),h.push(a)}if(s()<.12&&w>60){const i=Math.floor(s()*3),a=new c(new ae(.1,.06,2.5,6),At);a.position.set(S[i],2.2,t-4),a.userData={type:"duck"},r.add(a),j.push(a);for(let d=0;d<3;d++){const g=new c(new N(.15,4,4),At);g.position.set(S[i]+(Math.random()-.5)*.4,1.8+d*.4,t-4+(Math.random()-.5)*.3),r.add(g),h.push(g)}}if(s()<.2){const i=s()<.5?-4.5:4.5,a=3+s()*2,d=new c(new b(.8,a,.8),Mo);d.position.set(i,a/2,t-3),d.castShadow=!0,r.add(d),h.push(d)}if(s()<.1&&w>120){const i=Math.floor(s()*3),a=new c(new b(1.5,1.2,5),xo);a.position.set(S[i],.6,t-20),a.userData={type:"train",speed:.15+s()*.1},r.add(a),O.push(a)}if(s()<.06&&w>150){const i=Math.floor(s()*3),a=new c(new b(1.8,.35,2.2),new m({color:9135424,roughness:.9}));a.position.set(S[i],.02,t-3),a.userData={type:"crumble",timer:1.2,shaking:!1,falling:!1,fallVy:0},r.add(a),j.push(a);const d=new c(new b(1.4,.02,.04),new D({color:3355443}));d.position.set(S[i],.2,t-3),r.add(d),h.push(d)}const f=Math.floor(s()*3);for(let i=0;i<3;i++){const a=new c(new ae(.22,.22,.05,8),go);a.position.set(S[f],1.2,t-i*2.2),a.rotation.x=Math.PI/2,r.add(a),ee.push(a)}if(s()<.14){const i=Math.floor(s()*3),a=new c(new pt(.25,0),yo);a.position.set(S[i],1.5,t-5),r.add(a),te.push(a)}if(s()<.14&&w>20){const i=Math.floor(s()*3),a=s()<.5?"shield":"magnet",d=a==="shield"?bo:Dt,g=new c(new N(.4,10,10),d);g.position.set(S[i],1.5,t-8),g.userData={type:a},r.add(g),J.push(g);const k=new c(new no(.55,.06,8,16),new D({color:a==="shield"?65535:16724838,transparent:!0,opacity:.5}));k.position.set(S[i],1.5,t-8),r.add(k),h.push(k)}if(s()<.2){const i=Math.floor(s()*3),a=new c(new b(.5,.5,.5),Tt);a.position.set(S[i],.5,t-6),a.userData={type:"ammo"},r.add(a),Y.push(a);const d=new c(new ae(.08,.08,.25,6),new D({color:16776960}));d.position.set(S[i],.5,t-6+.28),d.rotation.x=Math.PI/2,r.add(d),h.push(d)}if(s()<.03&&w>150){const i=Math.floor(s()*3),a=new c(new pt(.4,0),Uo);a.position.set(S[i],1.5,t-9),a.userData={type:"rampage"},r.add(a),de.push(a);const d=new c(new no(.6,.08,8,16),new D({color:16729088,transparent:!0,opacity:.6}));d.position.set(S[i],1.5,t-9),r.add(d),h.push(d)}if(s()<.045&&w>140&&o.shopMode<=0){const i=s()<.5?-1:1,a=new c(new b(4.5,3.2,2.6),new m({color:8150337,roughness:.85}));a.position.set(i*7.2,1.6,t-4),r.add(a),h.push(a);const d=new c(new b(3,.5,.15),new D({color:16763972}));d.position.set(i*7.2,3.4,t-4),r.add(d),h.push(d);const g=Math.floor(s()*3),k=new c(new b(.9,.9,.9),new D({color:16729258}));k.position.set(S[g],.8,t-1),k.userData={type:"shopTrigger",side:i},r.add(k),j.push(k)}}function Kt(t){if(G)return;const s=Math.min((t-le)/1e3,.1);if(le=t,o.started&&!o.over&&!o.paused&&$o(s),o.over&&o.deathAnim>0&&(o.deathAnim-=s,u.rotation.x+=s*8,u.position.y+=s*(o.deathAnim>.3?3:-5),u.position.y<-5&&(o.deathAnim=0)),!o.paused){for(const p of ee)p.rotation.z+=s*3;for(const p of te)p.rotation.y+=s*2,p.rotation.z+=s*1.5;for(const p of J)p.rotation.y+=s*3;for(const p of Y)p.rotation.y+=s*2;for(const p of O)p.rotation.x+=s*5,p.rotation.y+=s*3}re.render(A,Z),Qe=requestAnimationFrame(Kt)}function $o(t){const s=o.speed*t*60;if(o.speed=Math.min(.55,o.speed+.004*t),o.dist+=s*5,o.bgmT-=t,o.bgmT<=0&&o.started&&!o.paused&&!o.over){const e=[220,247,294,262,196,247,294,330];x(e[o.bgmStep%e.length],.16,"triangle",.02),o.bgmStep%4===0&&x(90,.1,"sine",.03),o.bgmStep++,o.bgmT=.28}o.shopMode>0&&(o.shopMode-=t,o.shopMode<=0&&P("üèÅ Leaving Gift Shop Alley"));const p=Math.floor(o.dist/300)%je.length;K!==je[p]&&(K=je[p],A.background.setHex(K.sky),A.fog.color.setHex(K.fog),Xe.color.setHex(K.ground),Je.color.setHex(K.groundAlt),be.color.setHex(K.wall),P("üåç "+K.name+" Biome"),yt(K.name));const w=Math.max(0,(o.speed-.25)/.3)*.4;for(const e of Lt)e.material.opacity=w,e.position.z+=s*2,e.position.z>10&&(e.position.z=-20-Math.random()*40);K.weather&&_o();for(let e=he.length-1;e>=0;e--){const n=he[e];if(n.life-=t,n.life<=0){A.remove(n.mesh),he.splice(e,1);continue}n.mesh.position.y+=n.vy*t*60,n.mesh.position.x+=(n.vx||0)*t*60,n.mesh.position.z+=s,n.mesh.material.opacity=Math.min(.7,n.life/n.maxLife)}o.turnCooldown>0&&(o.turnCooldown-=t);let v=!1;for(let e=we.length-1;e>=0;e--){const n=we[e];if(!n.userData.triggered&&n.position.z>-12&&n.position.z<8&&(v=!0),n.position.z>20){r.remove(n);const y=j.indexOf(n);y>=0&&j.splice(y,1),we.splice(e,1)}}if(Re(v),o.turnSwoop>0){o.turnSwoop-=t;const e=o.turnSwoop/.5;Z.fov=70+Math.sin(e*Math.PI)*15,Z.updateProjectionMatrix()}else Math.abs(Z.fov-70)>.1&&(Z.fov=70,Z.updateProjectionMatrix());o.shield>0?(o.shield-=t,$.visible=!0,$.material.opacity=.15+Math.sin(le*.01)*.05,o.shield<=0&&(_(null),$.visible=!1)):$.visible=!1,o.magnet>0&&(o.magnet-=t,o.magnet<=0&&o.shield<=0&&_(null));const f=r.children;for(let e=0,n=f.length;e<n;e++)f[e].position.z+=s;for(let e=X.length-1;e>=0;e--)X[e].position.z>22&&(r.remove(X[e]),X.splice(e,1));for(let e=Q.length-1;e>=0;e--)Q[e].position.z>22&&(r.remove(Q[e]),Q.splice(e,1));for(let e=h.length-1;e>=0;e--)h[e].position.z>22&&(r.remove(h[e]),h.splice(e,1));for(;X.length<8;)se-=q,lt(se);se+=s;for(let e=j.length-1;e>=0;e--)j[e].position.z>15&&(r.remove(j[e]),j.splice(e,1));for(let e=O.length-1;e>=0;e--)O[e].position.z>15&&(r.remove(O[e]),O.splice(e,1));for(let e=ee.length-1;e>=0;e--)ee[e].position.z>15&&(r.remove(ee[e]),ee.splice(e,1));for(let e=te.length-1;e>=0;e--)te[e].position.z>15&&(r.remove(te[e]),te.splice(e,1));for(let e=J.length-1;e>=0;e--)J[e].position.z>15&&(r.remove(J[e]),J.splice(e,1));for(let e=Y.length-1;e>=0;e--)Y[e].position.z>15&&(r.remove(Y[e]),Y.splice(e,1));for(let e=fe.length-1;e>=0;e--)fe[e].position.z>25&&(r.remove(fe[e]),fe.splice(e,1));for(let e=ge.length-1;e>=0;e--)ge[e].position.z>20&&(r.remove(ge[e]),ge.splice(e,1));for(ce+=s;ce>se+30;)ce-=15,ct(ce);if(o.rampage>0){if(o.rampage-=t,o.rampageShotTimer-=t,o.rampageShotTimer<=0){o.rampageShotTimer=.08;for(const e of[-1.5,0,1.5]){const n=new c(new N(.18,6,6),Pe);n.position.set(u.position.x+e,u.position.y+1.2,u.position.z-.5),A.add(n),W.push(n)}if(Math.random()<.3)for(const e of[-3,3]){const n=new c(new N(.15,6,6),Pe);n.position.set(u.position.x+e,u.position.y+1+Math.random(),u.position.z-Math.random()*3),A.add(n),W.push(n)}Math.random()<.4&&T("destroy")}U.material.emissive=new ke(16729088),U.material.emissiveIntensity=.3+Math.sin(le*.02)*.2,o.rampage<=0&&(o.rampage=0,Te(!1),_(null),U.material.emissive=new ke(0),U.material.emissiveIntensity=0,P("üí• Rampage Over!"))}for(let e=de.length-1;e>=0;e--){const n=de[e];n.rotation.y+=t*4,n.rotation.x+=t*2,n.position.z>15&&(r.remove(n),de.splice(e,1))}for(let e=de.length-1;e>=0;e--){const n=de[e];Math.abs(u.position.x-n.position.x)<1.2&&Math.abs(n.position.z)<1.5&&(r.remove(n),de.splice(e,1),o.rampage=5,o.rampageShotTimer=0,Te(!0),_("rampage"),T("rampage"),P("üî•üí• RAMPAGE MODE! üî•üí•"))}for(const e of O)e.position.z+=(e.userData.speed+o.speed*.3)*t*60;for(const e of j){if(e.userData.type!=="crumble")continue;const n=Math.abs(e.position.z);Math.abs(u.position.x-e.position.x)<1.2&&n<1.5&&!e.userData.shaking&&!e.userData.falling&&(e.userData.shaking=!0,T("crumble")),e.userData.shaking&&!e.userData.falling&&(e.userData.timer-=t,e.position.x+=(Math.random()-.5)*.08,e.userData.timer<=0&&(e.userData.falling=!0,e.userData.fallVy=0)),e.userData.falling&&(e.userData.fallVy-=.03,e.position.y+=e.userData.fallVy)}for(let e=W.length-1;e>=0;e--){const n=W[e],y=n.userData||{};n.position.z-=y.speed||1.2,y.vx&&(n.position.x+=y.vx),y.vy!==void 0&&(y.vy+=Nt*.55,n.position.y+=y.vy),y.life!==void 0&&(y.life-=t);let ie=!1;for(let C=j.length-1;C>=0;C--){const z=j[C],I=Math.abs(n.position.x-z.position.x),ue=Math.abs(n.position.z-z.position.z);if(!(I>1.1||ue>1.1)){if(z.userData.type==="shopTrigger"){const Ee=z.userData.side||1;r.remove(z),j.splice(C,1),Xo(Ee),(y.pierce||0)<=0?(A.remove(n),W.splice(e,1),ie=!0):y.pierce--;break}if(z.userData.type!=="gap"&&z.userData.type!=="deadwall"){Me(z.position.x,z.position.y+.5,z.position.z),r.remove(z),j.splice(C,1),(y.pierce||0)<=0?(A.remove(n),W.splice(e,1),ie=!0):y.pierce--;break}}}if(!ie){if(y.blast&&(y.life<=0||n.position.y<=0)){T("explode"),Me(n.position.x,Math.max(.2,n.position.y),n.position.z);for(let C=j.length-1;C>=0;C--){const z=j[C];if(z.userData.type==="gap"||z.userData.type==="deadwall")continue;const I=Math.abs(n.position.x-z.position.x),ue=Math.abs(n.position.z-z.position.z);I<y.blast&&ue<y.blast&&(r.remove(z),j.splice(C,1))}for(let C=O.length-1;C>=0;C--){const z=O[C],I=Math.abs(n.position.x-z.position.x),ue=Math.abs(n.position.z-z.position.z);I<y.blast&&ue<y.blast&&(r.remove(z),O.splice(C,1))}A.remove(n),W.splice(e,1);continue}if(L.visible){const C=Math.abs(n.position.x-L.position.x),z=Math.abs(n.position.y-(L.position.y+1.5)),I=Math.abs(n.position.z-L.position.z);if(C<.8&&z<1.2&&I<1){(y.pierce||0)<=0?(A.remove(n),W.splice(e,1)):y.pierce--,o.guardianHealth-=y.dmg||1,T("hit"),Me(L.position.x,L.position.y+1.5,L.position.z),o.guardianHealth<=0&&(L.visible=!1,L.position.z=-200,o.guardDist=-200,o.guardianHealth=3,o.guardsKilled++,ne("killGuard"),P("‚öîÔ∏è Guardian Killed! +10 coins"),o.coins+=10,V(o.coins));continue}}if(R.visible){const C=Math.abs(n.position.x-R.position.x),z=Math.abs(n.position.y-(R.position.y+2)),I=Math.abs(n.position.z-R.position.z);if(C<1.2&&z<2&&I<1.2){(y.pierce||0)<=0?(A.remove(n),W.splice(e,1)):y.pierce--,o.bossHealth-=y.dmg||1,T("hit"),Me(R.position.x,R.position.y+2,R.position.z),o.bossHealth<=0&&(R.visible=!1,R.position.z=-200,o.bossActive=!1,o.coins+=25,V(o.coins),ne("killBoss"),P("üëπ BOSS DEFEATED! +25 coins"));continue}}if(o.rampage>0){let C=!1;for(let z=j.length-1;z>=0;z--){const I=j[z];if(I.userData.type==="gap")continue;const ue=Math.abs(n.position.x-I.position.x),Ee=Math.abs(n.position.z-I.position.z);if(ue<1.2&&Ee<1){Me(I.position.x,I.position.y+.5,I.position.z),r.remove(I),j.splice(z,1),A.remove(n),W.splice(e,1),o.coins++,V(o.coins),C=!0;break}}if(C)continue;for(let z=O.length-1;z>=0;z--){const I=O[z],ue=Math.abs(n.position.x-I.position.x),Ee=Math.abs(n.position.z-I.position.z);if(ue<1.2&&Ee<1.5){Me(I.position.x,I.position.y,I.position.z),r.remove(I),O.splice(z,1),A.remove(n),W.splice(e,1),o.coins++,V(o.coins),C=!0;break}}if(C)continue}(n.position.z<-120||Math.abs(n.position.x)>20||n.position.y<-6)&&(A.remove(n),W.splice(e,1))}}if(u.position.x+=(S[l.lane]-u.position.x)*12*t,l.onZipline){if(l.zipT-=t,l.zipDown){const e=1-l.zipT/2;l.y=l.zipStartY*(1-e*e),l.y<.1&&(l.y=.1)}else l.y=3.2+Math.sin(l.zipT*3)*.08;u.position.y=l.y,l.zipT<=0&&(l.onZipline=!1,l.zipDown=!1,l.y>.5?(l.jumping=!0,l.vy=.05,l.canDbl=!0):(l.y=0,l.jumping=!1,l.canDbl=!0,T("land")))}else l.jumping&&(l.fastFall?l.vy=-.5:l.vy+=Nt,l.y+=l.vy,l.y<=0&&(l.y=0,l.vy=0,l.jumping=!1,l.canDbl=!0,l.fastFall?(T("slam"),Qo(u.position.x,0,0),l.fastFall=!1):(T("land"),He(u.position.x,0,0)))),u.position.y=l.y;l.ducking&&(l.duckT-=t,l.duckT<=0&&(l.ducking=!1));const i=u.userData;l.runT+=t*(8+o.speed*12);const a=Math.sin(l.runT),d=Math.sin(l.runT+Math.PI);if(l.ducking?(u.scale.y=.55,u.rotation.x=0,i.body.position.y=.55,i.head.position.y=1.15,i.lLeg.rotation.x=1.2,i.rLeg.rotation.x=.4,i.lArm.rotation.x=-.3,i.rArm.rotation.x=.3,i.lArm.rotation.z=.6,i.rArm.rotation.z=-.6):l.onZipline?(u.scale.y=1,u.rotation.x=0,i.body.position.y=1.2,i.head.position.y=2,i.lArm.rotation.x=-3,i.rArm.rotation.x=-3,i.lLeg.rotation.x=.2,i.rLeg.rotation.x=-.2,i.lArm.rotation.z=0,i.rArm.rotation.z=0):(u.scale.y=1,u.rotation.x=.1+Math.abs(a)*.03,i.body.position.y=1.2+.04*Math.abs(a),i.head.position.y=2+.03*Math.abs(a),i.lLeg.rotation.x=a*.7,i.rLeg.rotation.x=-a*.7,i.lArm.rotation.x=d*.6,i.rArm.rotation.x=-d*.6,i.lArm.rotation.z=0,i.rArm.rotation.z=0,!l.jumping&&!l.onZipline&&(u.position.y=l.y+Math.abs(Math.sin(l.runT))*.06)),o.trackType==="water"&&l.y<.3&&!l.jumping&&!l.onZipline&&o.shield<=0){let e=!1;for(const n of ge)if(n.userData.lane===l.lane&&Math.abs(n.position.z)<8){e=!0;break}if(!e){T("splash"),P("üåä You sank!"),pe();return}}if(o.shield<=0&&o.shopMode<=0){for(const e of j){if(e.userData.type==="crumble"&&e.userData.falling)continue;const n=Math.abs(e.position.z);if(!(n>2)){if(e.userData.type==="deadwall"&&n<1.2){pe();return}if(e.userData.type==="gap"&&n<1.5&&l.y<.5&&!l.onZipline){pe();return}if(e.userData.type==="jump"){if(Math.abs(u.position.x-e.position.x)<.9&&n<.6&&l.y<.8){pe();return}}else if(e.userData.type==="duck"&&n<.5&&!l.ducking&&l.y<e.position.y-.6){pe();return}}}for(const e of O){const n=Math.abs(u.position.x-e.position.x),y=Math.abs(u.position.y-e.position.y),ie=Math.abs(e.position.z);if(e.userData.type==="train"){if(n<1&&ie<2.5&&l.y<1.5){pe();return}}else if(n<.5&&y<.5&&ie<.5){pe();return}}}if(l.jumping&&!l.onZipline)for(const e of fe){const n=Math.abs(u.position.x-S[e.userData.lane]),y=Math.abs(e.position.z);if(n<1.2&&y<8&&l.y>2){l.onZipline=!0,l.vy=0,l.jumping=!1,e.userData.downward?(l.zipDown=!0,l.zipT=2,l.zipStartY=l.y,T("zip"),P("‚¨áÔ∏è Downward Zipline!")):(l.zipDown=!1,l.zipT=1.5,T("zip"),P("ü™¢ Zipline!"));break}}for(let e=ee.length-1;e>=0;e--){const n=ee[e],y=Math.abs(u.position.x-n.position.x),ie=o.magnet>0?2.5:1;y<ie&&Math.abs(n.position.z)<(o.magnet>0?3:1)&&(r.remove(n),ee.splice(e,1),o.coins++,V(o.coins),o.dist-o.lastCoin<100?(o.combo++,o.combo>=10&&o.mult<5&&(o.mult++,Ne(o.mult))):(o.combo=0,o.mult=1,Ne(1)),o.lastCoin=o.dist,Ze(o.combo),T("coin"),He(n.position.x,n.position.y,n.position.z),o.coins>=200?ne("coins200"):o.coins>=100?ne("coins100"):o.coins>=50&&ne("coins50"),o.combo>=20&&ne("combo20"))}for(let e=te.length-1;e>=0;e--){const n=te[e];Math.abs(u.position.x-n.position.x)<1&&Math.abs(n.position.z)<1&&(r.remove(n),te.splice(e,1),o.gems++,o.coins+=5,V(o.coins),T("gem"),He(n.position.x,n.position.y,n.position.z,16711935))}for(let e=J.length-1;e>=0;e--){const n=J[e];if(Math.abs(u.position.x-n.position.x)<1.2&&Math.abs(n.position.z)<1.2){if(r.remove(n),J.splice(e,1),n.userData.type==="shield")o.shield=8,_("shield"),T("shield"),P("üõ°Ô∏è Shield Active!");else if(n.userData.type==="magnet")o.magnet=10,_("magnet"),P("üß≤ Magnet Active!");else if(n.userData.type==="weapon"){const y=["pistol","shotgun","laser","grenade"],ie=y[(y.indexOf(o.weapon)+1)%y.length];Vo(ie)}T("powerup")}}for(let e=Y.length-1;e>=0;e--){const n=Y[e];Math.abs(u.position.x-n.position.x)<1&&Math.abs(n.position.z)<1.2&&(r.remove(n),Y.splice(e,1),n.userData.type==="grenade"?(o.grenades=Math.min(o.grenades+2,12),xt(o.grenades),T("ammo"),P("üí£ +2 Grenades!")):(o.ammo=Math.min(o.ammo+6,30),Ae(o.ammo),T("ammo"),P("üî´ +6 Ammo!")),He(n.position.x,n.position.y,n.position.z,4521796))}if(o.dist>250&&!L.visible&&!o.bossActive&&(L.visible=!0,o.guardDist=-80,o.guardianHealth=3,T("guard"),P("‚ö†Ô∏è Guardian is chasing you!")),L.visible){o.guardDist+=(o.speed*.7+.15)*t*60,L.position.z=o.guardDist,L.position.x+=(u.position.x-L.position.x)*2*t,L.rotation.y=Math.sin(le*.005)*.3;const e=Math.abs(u.position.x-L.position.x),n=Math.abs(u.position.y-L.position.y),y=Math.abs(u.position.z-L.position.z);if(e<.35&&n<.35&&y<.7&&o.shield<=0){pe();return}}const g=Math.floor(o.dist/1200);if(g>o.lastBossDist&&!o.bossActive&&(o.lastBossDist=g,o.bossActive=!0,o.bossHealth=8,R.visible=!0,R.position.set(0,0,-60),L.visible=!1,L.position.z=-200,o.guardDist=-200,T("boss"),P("üëπ BOSS INCOMING!")),R.visible&&(R.position.z+=(o.speed*.5+.1)*t*60,R.position.x+=(u.position.x-R.position.x)*1.5*t,R.rotation.y=Math.sin(le*.004)*.4,R.position.z>-5&&o.shield<=0&&l.y<3)){pe();return}o.dist>=5e3?ne("dist5000"):o.dist>=2500?ne("dist2500"):o.dist>=1e3?ne("dist1000"):o.dist>=500&&ne("dist500");let k=!1;for(const e of xe)e.done||(e.type==="coins"&&o.coins>=e.target&&(e.done=!0,P("‚úÖ Mission: "+e.desc),o.coins+=10,V(o.coins),k=!0),e.type==="dist"&&o.dist>=e.target&&(e.done=!0,P("‚úÖ Mission: "+e.desc),o.coins+=10,V(o.coins),k=!0),e.type==="killGuard"&&o.guardsKilled>=e.target&&(e.done=!0,P("‚úÖ Mission: "+e.desc),o.coins+=10,V(o.coins),k=!0));k&&Ye([...xe]);for(let e=oe.length-1;e>=0;e--){const n=oe[e];if(n.life-=t,n.life<=0){A.remove(n.mesh),oe.splice(e,1);continue}n.vy-=.02,n.mesh.position.y+=n.vy,n.vx!==void 0&&(n.mesh.position.x+=n.vx),n.vz!==void 0&&(n.mesh.position.z+=n.vz),n.mesh.position.z+=s,n.mesh.material.opacity=n.life/n.maxLife}ut(Math.floor(o.dist*o.mult));const F=o.turnSwoop>0?Math.sin(o.turnSwoop*20)*o.turnSwoop*2.5:0;Z.position.x+=(u.position.x+F-Z.position.x)*5*t,Z.position.z+=(8-Z.position.z)*3*t,Z.position.y=4.5+l.y*.3,Z.lookAt(u.position.x,1.2,-10)}function _o(){if(Math.random()>.3)return;const t=K.weather;let s=16777215,p=.05,w=-.05,v=2;if(t==="snow")s=15658751,p=.06,w=-.03;else if(t==="ember")s=16737792,p=.04,w=.02,v=1.5;else if(t==="sand")s=13412966,p=.03,w=-.01;else if(t==="dust")s=8947848,p=.04,w=-.02;else if(t==="leaves")s=4500002,p=.08,w=-.04;else if(t==="cloud")s=16777215,p=.15,w=0,v=3;else if(t==="star")s=16777130,p=.03,w=0,v=4;else return;const f=new c(new N(p,4,4),new D({color:s,transparent:!0,opacity:.6}));f.position.set((Math.random()-.5)*14,3+Math.random()*4,-5-Math.random()*20),A.add(f),he.push({mesh:f,vy:w,vx:(Math.random()-.5)*.02,life:v,maxLife:v})}function He(t,s,p,w=16768256){for(let v=0;v<5;v++){const f=new c(new N(.08,4,4),new D({color:w,transparent:!0}));f.position.set(t+(Math.random()-.5)*.3,s+Math.random()*.3,p),A.add(f),oe.push({mesh:f,vy:Math.random()*.15,life:.5,maxLife:.5})}}function Qo(t,s,p){for(let w=0;w<16;w++){const v=w/16*Math.PI*2,f=new c(new N(.1,4,4),new D({color:11184810,transparent:!0}));f.position.set(t,s+.1,p),A.add(f),oe.push({mesh:f,vx:Math.cos(v)*.12,vz:Math.sin(v)*.12,vy:.08,life:.6,maxLife:.6})}}function Me(t,s,p){for(let w=0;w<8;w++){const v=new c(new N(.08,4,4),new D({color:16711680,transparent:!0}));v.position.set(t,s,p),A.add(v),oe.push({mesh:v,vx:(Math.random()-.5)*.15,vy:Math.random()*.2,vz:(Math.random()-.5)*.15,life:.4,maxLife:.4})}}let ze=null;function P(t){wt(t),ze&&clearTimeout(ze),ze=setTimeout(()=>wt(null),2200)}function ne(t){!t||Ge[t]||(Ge[t]=!0,T("achieve"),P("üèÜ "+Yo[t]))}function pe(){if(o.superMode){Ut();return}o.over=!0,o.started=!1,o.deathAnim=.8;const t=Math.floor(o.dist*o.mult);t>ye&&(ro(t),localStorage.setItem("tr2Best",String(t))),_(null),Ze(0),Ne(1),$.visible=!1,o.rampage=0,Te(!1),U.material.emissive=new ke(0),U.material.emissiveIntensity=0,T("death"),Re(!1),Ue(o.coins>=20&&!o.resurrected),Le("over")}function Ut(){console.log("youre not dying anymore")}function Yt(){o.superMode=!0,o.shield=1e9,$.visible=!0,_("shield"),P("‚ö° SUPER MODE ENABLED"),Ut()}function es(){if(o.coins<20||o.resurrected)return;o.coins-=20,V(o.coins),o.resurrected=!0,o.over=!1,o.started=!0,o.deathAnim=0,o.shield=3,o.rampage=0,$.visible=!0,_("shield"),Te(!1),U.material.emissive=new ke(0),U.material.emissiveIntensity=0,Ue(!1),l.y=0,l.vy=0,l.jumping=!1,l.ducking=!1,l.fastFall=!1,l.onZipline=!1,u.position.y=0,u.scale.y=1,u.rotation.x=0;const t=u.userData;t.body.position.y=1.2,t.head.position.y=2,t.lLeg.rotation.x=0,t.rLeg.rotation.x=0,t.lArm.rotation.set(0,0,0),t.rArm.rotation.set(0,0,0),L.visible=!1,L.position.z=-200,o.guardDist=-200,R.visible=!1,R.position.z=-200,o.bossActive=!1,le=performance.now(),T("resurrect"),P("‚ú® Resurrected!"),Le("playing")}function Oe(t){if(!(!o.started||o.over||o.paused)){if(t==="left"||t==="right")for(let s=we.length-1;s>=0;s--){const p=we[s];if(!p.userData.triggered&&p.position.z>-6&&p.position.z<6){p.userData.triggered=!0;const w=j.indexOf(p);w>=0&&j.splice(w,1),p.visible=!1;const v=Do.filter(f=>f!==o.trackType);o.trackType=v[Math.floor(Math.random()*v.length)];for(let f=X.length-1;f>=0;f--)X[f].position.z<-5&&(r.remove(X[f]),X.splice(f,1));for(let f=Q.length-1;f>=0;f--)Q[f].position.z<-5&&(r.remove(Q[f]),Q.splice(f,1));for(let f=h.length-1;f>=0;f--)h[f].position.z<-5&&(r.remove(h[f]),h.splice(f,1));o.turnSwoop=.5,o.turnCooldown=18,T("turn"),T("trackchange"),P((t==="left"?"‚¨ÖÔ∏è":"‚û°Ô∏è")+" "+Et[o.trackType]),vt(Et[o.trackType]),Re(!1);return}}t==="left"&&l.lane>0?l.lane--:t==="right"&&l.lane<2?l.lane++:t==="jump"&&!l.jumping&&!l.onZipline?(l.jumping=!0,l.vy=.38,l.ducking&&(l.ducking=!1,u.scale.y=1),T("jump")):t==="jump"&&l.jumping&&l.canDbl?(l.canDbl=!1,l.vy=.36,T("djump")):t==="duck"&&!l.jumping&&!l.onZipline?(l.ducking=!0,l.duckT=.6,T("slide")):t==="duck"&&l.jumping&&!l.fastFall&&(l.fastFall=!0,T("fastfall"))}}function Vt(){Ko(),xe=Rt(),Ye([...xe]),o.inMenu=!1,o.started=!0,T("start"),Le("playing")}function Xt(){for(let s=r.children.length-1;s>=0;s--)r.remove(r.children[s]);for(let s=oe.length-1;s>=0;s--)A.remove(oe[s].mesh);for(let s=W.length-1;s>=0;s--)A.remove(W[s]);for(let s=he.length-1;s>=0;s--)A.remove(he[s].mesh);X=[],Q=[],j=[],O=[],ee=[],te=[],J=[],Y=[],oe=[],h=[],W=[],fe=[],he=[],we=[],de=[],ge=[],o=Pt(),o.inMenu=!1,o.started=!0,vt(""),Re(!1),l=Gt(),xe=Rt(),Ye([...xe]),L.visible=!1,L.position.z=-100,R.visible=!1,R.position.z=-200,$.visible=!1,K=je[0],yt(""),A.background.setHex(K.sky),A.fog.color.setHex(K.fog),Xe.color.setHex(K.ground),Je.color.setHex(K.groundAlt),be.color.setHex(K.wall),Z.fov=70,Z.updateProjectionMatrix(),u.position.set(0,0,0),u.scale.y=1,u.rotation.x=0;const t=u.userData;t.body.position.y=1.2,t.head.position.y=2,t.lLeg.rotation.x=0,t.rLeg.rotation.x=0,t.lArm.rotation.set(0,0,0),t.rArm.rotation.set(0,0,0),se=q;for(let s=0;s<8;s++)se-=q,lt(se);ce=-30;for(let s=0;s<4;s++)ce-=15,ct(ce);Object.keys(Ge).forEach(s=>Ge[s]=!1),U.material.emissive=new ke(0),U.material.emissiveIntensity=0,ut(0),V(0),Ae(12),Ze(0),Ne(1),_(null),Te(!1),Ue(!1),Le("playing")}function Jt(){!o.started||o.over||(o.paused=!o.paused,ao(o.paused),o.paused||(le=performance.now()))}function ts(){if(o.superMode){P("‚ö° SUPER MODE ALREADY ON");return}Yt()}function $t(t){if(t.code==="Z"&&(t.ctrlKey||t.metaKey)){t.preventDefault(),Yt();return}if(t.code==="Space"||t.code==="Enter"){t.preventDefault(),o.inMenu?Vt():o.over?Xt():o.started&&Oe("jump");return}if(t.code==="KeyP"||t.code==="Escape"){t.preventDefault(),Jt();return}if(t.code==="KeyF"){t.preventDefault(),Jo();return}if(o.paused)return;const s={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"jump",ArrowDown:"duck",KeyA:"left",KeyD:"right",KeyW:"jump",KeyS:"duck"};s[t.code]&&(t.preventDefault(),Oe(s[t.code]))}let _t=0,Qt=0;function eo(t){_t=t.touches[0].clientX,Qt=t.touches[0].clientY}function to(t){const s=t.changedTouches[0].clientX-_t,p=t.changedTouches[0].clientY-Qt;Math.max(Math.abs(s),Math.abs(p))<25||(Math.abs(s)>Math.abs(p)?Oe(s>0?"right":"left"):Oe(p>0?"duck":"jump"))}function oo(){if(!Se.current)return;const t=Se.current.clientWidth,s=Se.current.clientHeight;Z.aspect=t/s,Z.updateProjectionMatrix(),re.setSize(t,s)}me.current={start:Vt,restart:Xt,togglePause:Jt,resurrect:es,enableSuperMode:ts},window.addEventListener("keydown",$t),window.addEventListener("resize",oo),E&&(E.addEventListener("touchstart",eo,{passive:!0}),E.addEventListener("touchend",to,{passive:!0})),se=q;for(let t=0;t<8;t++)se-=q,lt(se);for(let t=0;t<4;t++)ce-=15,ct(ce);return le=performance.now(),Qe=requestAnimationFrame(Kt),()=>{if(G=!0,cancelAnimationFrame(Qe),window.removeEventListener("keydown",$t),window.removeEventListener("resize",oo),E&&(E.removeEventListener("touchstart",eo),E.removeEventListener("touchend",to)),re.dispose(),re.domElement.parentNode===E&&E.removeChild(re.domElement),B)try{B.close()}catch{}ze&&clearTimeout(ze)}},[]),M.jsxs("div",{className:"tr2-root",children:[M.jsx("div",{ref:Se,className:"tr2-canvas"}),ht&&M.jsx("div",{className:"tr2-notify",children:ht}),mo&&M.jsx("div",{style:{position:"absolute",top:"42%",left:"50%",transform:"translate(-50%,-50%)",color:"#00ff44",fontSize:"2.2em",fontWeight:"bold",textShadow:"0 0 20px #00ff44, 0 0 40px #00ff44",animation:"pulse 0.5s ease-in-out infinite",pointerEvents:"none",zIndex:20,background:"rgba(0,0,0,0.5)",padding:"10px 28px",borderRadius:"14px",border:"2px solid #00ff44",letterSpacing:"2px"},children:"‚¨ÖÔ∏è TURN! ‚û°Ô∏è"}),qe==="menu"&&M.jsxs("div",{className:"tr2-overlay",children:[M.jsx("h1",{className:"tr2-title",children:"üèÉ Temple Runner"}),ye>0&&M.jsxs("div",{className:"tr2-best",children:["üèÜ Best: ",ye.toLocaleString()]}),M.jsx("p",{className:"tr2-sub",children:"Arrow Keys / WASD / Swipe"}),M.jsx("p",{className:"tr2-sub sm",children:"‚Üë Jump (2x) ¬† ‚Üì Duck/FastFall ¬† ‚Üê ‚Üí Lanes ¬† F Shoot"}),M.jsx("p",{className:"tr2-sub sm",children:"P/Esc Pause ¬† Jump mid-air for ziplines"}),M.jsx("button",{className:"tr2-btn play",onClick:()=>{var G,E;return(E=(G=me.current).start)==null?void 0:E.call(G)},children:"‚ñ∂ PLAY"}),M.jsx("p",{className:"tr2-sub sm",children:"or press SPACE"})]}),qe==="playing"&&M.jsxs(M.Fragment,{children:[M.jsxs("div",{className:"tr2-hud",children:[M.jsxs("div",{className:"tr2-left",children:[M.jsx("div",{className:"tr2-score",children:Fe.toLocaleString()}),ft>1&&M.jsxs("div",{className:"tr2-mult",children:["x",ft]}),mt>0&&M.jsxs("div",{className:"tr2-combo",children:[mt," combo!"]}),gt&&M.jsx("div",{className:"tr2-biome",children:gt}),bt&&M.jsx("div",{className:"tr2-biome",style:{color:"#ffaa44",marginTop:2},children:bt})]}),M.jsx("button",{className:"tr2-pause-btn",onClick:()=>{var G,E;return(E=(G=me.current).togglePause)==null?void 0:E.call(G)},children:"‚è∏"}),M.jsxs("div",{className:"tr2-right",children:[M.jsxs("div",{className:"tr2-coins",children:["ü™ô ",dt]}),M.jsxs("div",{className:"tr2-ammo",children:["üî´ ",lo]}),M.jsx("button",{className:"tr2-btn super",style:{padding:"6px 10px",fontSize:"0.8em",pointerEvents:"auto"},onClick:()=>{var G,E;return(E=(G=me.current).enableSuperMode)==null?void 0:E.call(G)},children:"‚ö° SUPER"}),Ke&&M.jsx("div",{className:"tr2-powerup",children:Ke==="shield"?"üõ°Ô∏è Shield":Ke==="rampage"?"üî• RAMPAGE":"üß≤ Magnet"}),uo&&M.jsx("div",{className:"tr2-rampage",children:"üí• BULLETS EVERYWHERE üí•"})]})]}),M.jsx("div",{className:"tr2-missions",children:po.map((G,E)=>M.jsxs("div",{className:"tr2-mission"+(G.done?" done":""),children:[G.done?"‚úÖ":"‚¨ú"," ",G.desc]},E))}),io&&M.jsxs("div",{className:"tr2-overlay pause",children:[M.jsx("h1",{className:"tr2-title pause",children:"‚è∏ PAUSED"}),M.jsx("button",{className:"tr2-btn resume",onClick:()=>{var G,E;return(E=(G=me.current).togglePause)==null?void 0:E.call(G)},children:"‚ñ∂ RESUME"}),M.jsx("p",{className:"tr2-sub sm",children:"or press P / Esc"})]})]}),qe==="over"&&M.jsxs("div",{className:"tr2-overlay",children:[M.jsx("h1",{className:"tr2-title dead",children:"GAME OVER"}),M.jsxs("p",{className:"tr2-sub",children:["Score: ",Fe.toLocaleString()]}),Fe>ye&&M.jsx("p",{className:"tr2-sub new",children:"üéâ NEW BEST!"}),M.jsxs("p",{className:"tr2-sub",children:["Coins: ",dt]}),ye>0&&M.jsxs("p",{className:"tr2-sub sm",children:["Best: ",ye.toLocaleString()]}),co&&M.jsx("button",{className:"tr2-btn resurrect",onClick:()=>{var G,E;return(E=(G=me.current).resurrect)==null?void 0:E.call(G)},children:"‚ú® Resurrect (20 coins)"}),M.jsx("button",{className:"tr2-btn restart",onClick:()=>{var G,E;return(E=(G=me.current).restart)==null?void 0:E.call(G)},children:"‚Üª PLAY AGAIN"}),M.jsx("p",{className:"tr2-sub sm",children:"or press SPACE"})]}),M.jsx(cs,{})]})}export{hs as default};
